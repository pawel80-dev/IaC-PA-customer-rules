name: 'PA customer rules dev'

on:
  push:
    branches:
      - 'dev'

  # Workflow needs to be started manually
  workflow_dispatch:
    inputs:
      action_type:
        description: 'PA available actions:'
        required: true
        default: 'PA-display-rules'
        type: choice
        options:
          - PA-display-rules
          - PA-add-rules

env:
  PA_API_URL: 'https://10.12.0.40'
  # the easiest way is to regenerate API key is to change the API user password
  PA_API_KEY: ${{ secrets.PA_API_KEY }}
  PA_EX_FILE_PATH: 'customer_rules/customer_A.xlsx'
  PA_EX_SHEET: 'Rules'
  PY_CODE_PATH: 'source'

jobs:
  pa_actions:
    name: 'PA customer rules actions'
    # if: ${{ github.event_name != 'workflow_dispatch' }}
    runs-on: self-hosted
    # runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v5

      - name: 'Python: Install'
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          architecture: 'x64'

      - name: 'Python: Install dependencies'
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r ${{ env.PY_CODE_PATH }}/requirements.txt

      - name: 'PA: Current config'
        if: ${{ github.event.inputs.action_type == 'PA-display-rules' }}
        run: |
          python ${{ env.PY_CODE_PATH }}/pa_current_config.py \
                 ${{ env.PA_API_URL }} \
                 ${{ env.PA_API_KEY }}

      - name: 'PA: validate the template file'
        if: ${{ github.event.inputs.action_type == 'PA-add-rules' }}
        run: |
          python ${{ env.PY_CODE_PATH }}/pa_temp_validation.py \
                 ${{ env.PA_EX_FILE_PATH }} \
                 ${{ env.PA_EX_SHEET }}

      - name: 'PA: Add customer rules'
        if: ${{ github.event.inputs.action_type == 'PA-add-rules' }}
        run: |
          python ${{ env.PY_CODE_PATH }}/pa_deploy_policies.py \
                 ${{ env.PA_API_URL }} \
                 ${{ env.PA_API_KEY }} \
                 ${{ env.PA_EX_FILE_PATH }} \
                 ${{ env.PA_EX_SHEET }}